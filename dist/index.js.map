{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { PriorityQueue } from '@coxy/queue'\n\nexport function promisePriorityQueue(concurrency = 1, defaultPriority = 0) {\n  if (Number(concurrency) <= 0) {\n    throw new TypeError('Expected `concurrency` to be a number from 1 and up')\n  }\n\n  const queue = new PriorityQueue()\n  let activeCount = 0\n  let pause = false\n\n  const next = () => {\n    if (pause) {\n      return\n    }\n    activeCount--\n    if (queue.size > 0) {\n      queue.dequeue()()\n    }\n  }\n\n  const run = async (fn, resolve) => {\n    activeCount++\n    const result = (async () => fn())()\n    resolve(result)\n\n    try {\n      await result\n    } catch {}\n\n    next()\n  }\n\n  const enqueue = (fn, priority: number, resolve) => {\n    queue.enqueue(run.bind(undefined, fn, resolve), priority)\n\n    ;(async () => {\n      await Promise.resolve()\n\n      if (activeCount < concurrency && queue.size > 0) {\n        queue.dequeue()()\n      }\n    })()\n  }\n\n  return {\n    add: <T>(fn, priority?: number): Promise<T> =>\n      new Promise((resolve) => {\n        enqueue(fn, priority || defaultPriority, resolve)\n      }),\n    get active(): number {\n      return activeCount\n    },\n    get pending(): number {\n      return queue.size\n    },\n    clear: (): void => {\n      queue.clear()\n    },\n    pause: (): void => {\n      pause = true\n    },\n    resume: (): void => {\n      pause = false\n      next()\n    },\n  }\n}\n"],"mappings":"4ZAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,0BAAAE,IAAA,eAAAC,EAAAH,GAAA,IAAAI,EAA8B,uBAEvB,SAASF,EAAqBG,EAAc,EAAGC,EAAkB,EAAG,CACzE,GAAI,OAAOD,CAAW,GAAK,EACzB,MAAM,IAAI,UAAU,qDAAqD,EAG3E,IAAME,EAAQ,IAAI,gBACdC,EAAc,EACdC,EAAQ,GAENC,EAAO,IAAM,CACbD,IAGJD,IACID,EAAM,KAAO,GACfA,EAAM,QAAQ,EAAE,EAEpB,EAEMI,EAAM,MAAOC,EAAIC,IAAY,CACjCL,IACA,IAAMM,GAAU,SAAYF,EAAG,GAAG,EAClCC,EAAQC,CAAM,EAEd,GAAI,CACF,MAAMA,CACR,MAAQ,CAAC,CAETJ,EAAK,CACP,EAEMK,EAAU,CAACH,EAAII,EAAkBH,IAAY,CACjDN,EAAM,QAAQI,EAAI,KAAK,OAAWC,EAAIC,CAAO,EAAGG,CAAQ,GAEtD,UACA,MAAM,QAAQ,QAAQ,EAElBR,EAAcH,GAAeE,EAAM,KAAO,GAC5CA,EAAM,QAAQ,EAAE,KAGtB,EAEA,MAAO,CACL,IAAK,CAAIK,EAAII,IACX,IAAI,QAASH,GAAY,CACvBE,EAAQH,EAAII,GAAYV,EAAiBO,CAAO,CAClD,CAAC,EACH,IAAI,QAAiB,CACnB,OAAOL,CACT,EACA,IAAI,SAAkB,CACpB,OAAOD,EAAM,IACf,EACA,MAAO,IAAY,CACjBA,EAAM,MAAM,CACd,EACA,MAAO,IAAY,CACjBE,EAAQ,EACV,EACA,OAAQ,IAAY,CAClBA,EAAQ,GACRC,EAAK,CACP,CACF,CACF","names":["index_exports","__export","promisePriorityQueue","__toCommonJS","import_queue","concurrency","defaultPriority","queue","activeCount","pause","next","run","fn","resolve","result","enqueue","priority"]}